# Crypto Price Server

HTTP-сервис на Go, который хранит список криптовалют в памяти, подтягивает названия и цены из CoinGecko (или локального эмулятора) и даёт REST-API для работы с ними.

## Что умеет сервис
- Добавлять монету по символу: проверяем наличие в CoinGecko, сохраняем имя, текущую цену и первую запись истории.
- Хранить перечень монет в памяти и отдавать его через `GET /crypto`.
- Возвращать конкретную монету (`GET /crypto/{symbol}`) с актуальной ценой и временем обновления.
- Принудительно обновлять цену (`PUT /crypto/{symbol}/refresh`): скачиваем новую стоимость, сохраняем в монету и дописываем запись в историю (храним до 100 последних точек).
- Предоставлять историю цен (`GET /crypto/{symbol}/history`).
- Считать агрегаты по истории (`GET /crypto/{symbol}/stats`): min/max/avg, абсолютное и процентное изменение, количество записей.
- Удалять монету из памяти (`DELETE /crypto/{symbol}`).

Ошибки возвращаются в JSON-формате `{ "error": "..." }`. Символы монет нормализуются в lowercase.

## Быстрый старт
```bash
./compile.sh && ./execute.sh    # сборка и запуск готового бинарника
# или
make run                         # go run cryptoserver.go
```
Сервер слушает `http://localhost:8080`. Порт можно изменить переменной окружения `PORT`.

### Источник цен
По умолчанию клиент пытается достучаться до `http://127.0.0.1:5050` (локальный `fakegecko`). Если он не поднят, используем публичный CoinGecko (`https://api.coingecko.com/api/v3`). Можно явно задать URL через `COINGECKO_BASE_URL`.

## API по шагам
- `POST /crypto` — добавить монету. Тело: `{ "symbol": "BTC" }`. Ответ 201 и объект монеты.
- `GET /crypto` — список монет без истории.
- `GET /crypto/{symbol}` — монета без истории.
- `PUT /crypto/{symbol}/refresh` — принудительная синхронизация цены, ответ содержит обновлённую монету.
- `GET /crypto/{symbol}/history` — массив записей `{ "price": ..., "timestamp": ... }`.
- `GET /crypto/{symbol}/stats` — текущая цена + вычисленные статистики.
- `DELETE /crypto/{symbol}` — удалить монету, ответ `{}`.

Пример рабочего сценария:
```bash
curl -X POST http://localhost:8080/crypto -H 'Content-Type: application/json' -d '{"symbol":"BTC"}'
curl http://localhost:8080/crypto
curl http://localhost:8080/crypto/BTC/stats
```

## Тестирование
Для автотестов нужен локальный эмулятор CoinGecko — иначе запросы в реальное API могут быть заблокированы.
```bash
# Терминал 1
 go run gecko/fakegecko/main.go
# Терминал 2
 COINGECKO_BASE_URL=http://127.0.0.1:5050 go test ./...
```

## Внутреннее устройство
- `repository/` — потокобезопасный in-memory репозиторий с историей и расчётом статистик.
- `gecko/` — HTTP-клиент CoinGecko и `fakegecko` для офлайн-режима.
- `server/` — HTTP-слой с маршрутизатором и хендлерами на каждый эндпоинт.
- `compile.sh`, `execute.sh`, `Makefile` — вспомогательные команды для сборки, запуска и тестов.
